'use strict';let cLib;function cancelEvent(a){a&&("isCancelled"in a&&(a.isCancelled=!0),!("preventDefault"in a)||"cancelable"in a&&!a.cancelable||a.preventDefault(),"stopPropagation"in a&&a.stopPropagation());return!1}function lerp(a,b,c,d,e){return(e-a)*(d-b)/(c-a)+b}function smoothStep(a,b,c){a=(c-a)/(b-a);return 0>=a?0:1<=a?1:a*a*(3-2*a)}
function zeroObject(a){for(let b in a)switch(typeof a[b]){case "function":break;case "boolean":a[b]=!1;break;case "number":a[b]=0;break;default:const c=a[b];Array.isArray(c)&&c.fill(null);a[b]=null}}
function setup(){function a(c){window.CLib(c).then(d=>{cLib=d;window.main&&window.main()},d=>{alert(d);throw d;})}Array.prototype.fill||(Array.prototype.fill=function(c,d,e){var g=this.length|0;d|=0;e=void 0===e?g:e|0;e=0>e?Math.max(g+e,0):Math.min(e,g);for(d=0>d?Math.max(g+d,0):Math.min(d,g);d<e;)this[d++]=c;return this});var b=window.CLibWasmBinary;b?(delete window.CLibWasmBinary,Promise.resolve(b).then(c=>{a({wasmBinary:c})},()=>{a()})):(b=window.CLibMemoryArrayBuffer)?(delete window.CLibMemoryArrayBuffer,
Promise.resolve(b).then(c=>{a({memoryInitializerRequest:{status:200,response:c}})},()=>{a()})):a()}setup();
class PointerHandler{constructor(a,b=null,c=null,d=null,e=!0,g=null){this.documentTarget=document.documentElement||document.body;this.element=a;this.downCallback=b;this.moveCallback=c;this.upCallback=d;this.boundExtraTouchStart=null;"onpointerdown"in a?(this.documentDownEvent="pointerdown",this.documentMoveEvent="pointermove",this.documentUpEvent="pointerup",this.documentCancelEvent="pointercancel",this.boundDocumentDown=this.pointerDown.bind(this),this.boundDocumentUp=this.pointerUp.bind(this),this.boundDocumentMove=
this.pointerMove.bind(this),"ontouchstart"in a&&(this.boundExtraTouchStart=this.extraTouchStart.bind(this))):"ontouchstart"in a?(this.documentDownEvent="touchstart",this.documentMoveEvent="touchmove",this.documentUpEvent="touchend",this.documentCancelEvent="touchcancel",this.boundDocumentDown=this.touchStart.bind(this),this.boundDocumentUp=this.touchEnd.bind(this),this.boundDocumentMove=this.touchMove.bind(this)):(this.documentDownEvent="mousedown",this.documentMoveEvent="mousemove",this.documentUpEvent=
"mouseup",this.documentCancelEvent=null,this.boundDocumentDown=this.mouseDown.bind(this),this.boundDocumentUp=this.mouseUp.bind(this),this.boundDocumentMove=this.mouseMove.bind(this));this.lazy=e;this.outsidePointerHandler=g;this.boundExtraTouchStart&&a.addEventListener("touchstart",this.boundExtraTouchStart);a.addEventListener(this.documentDownEvent,this.boundDocumentDown);e||this.addSecondaryHandlers();this._captured=!1;this.pointerId=-1}destroy(){this.element&&(this.boundExtraTouchStart&&this.element.removeEventListener("touchstart",
this.boundExtraTouchStart),this.boundDocumentDown&&this.element.removeEventListener(this.documentDownEvent,this.boundDocumentDown));this.removeSecondaryHandlers();this.mouseUp({});zeroObject(this)}get captured(){return this._captured}addSecondaryHandlers(){this.documentTarget&&(this.documentTarget.addEventListener(this.documentMoveEvent,this.boundDocumentMove,{capture:!0,passive:!1}),this.documentTarget.addEventListener(this.documentUpEvent,this.boundDocumentUp,!0),this.documentCancelEvent&&this.documentTarget.addEventListener(this.documentCancelEvent,
this.boundDocumentUp,!0))}removeSecondaryHandlers(){this.documentTarget&&(this.boundDocumentUp&&(this.documentTarget.removeEventListener(this.documentUpEvent,this.boundDocumentUp,!0),this.documentCancelEvent&&this.documentTarget.removeEventListener(this.documentCancelEvent,this.boundDocumentUp,!0)),this.boundDocumentMove&&this.documentTarget.removeEventListener(this.documentMoveEvent,this.boundDocumentMove,!0))}extraTouchStart(a){if(a.target===this.element||this.outsidePointerHandler&&this.outsidePointerHandler(a))return cancelEvent(a)}pointerDown(a){if(0<=
this.pointerId&&"mouse"!==a.pointerType)return cancelEvent(a);const b=this.mouseDown(a);this._captured&&(this.pointerId=a.pointerId);return b}pointerMove(a){if(this._captured&&a.pointerId===this.pointerId)return this.mouseMove(a)}pointerUp(a){if(this._captured&&a.pointerId===this.pointerId)return this.pointerId=-1,this.mouseUp(a)}touchStart(a){if(!(1<a.touches.length))return 0<=this.pointerId&&this.touchEnd(a),this.pointerId=1,a.clientX=a.touches[0].clientX,a.clientY=a.touches[0].clientY,a=this.mouseDown(a),
void 0===a&&(this.pointerId=-1),a}touchMove(a){if(this._captured&&!(1<a.touches.length))return a.clientX=a.touches[0].clientX,a.clientY=a.touches[0].clientY,this.mouseMove(a)}touchEnd(a){if(this._captured&&!(0>this.pointerId))return this.pointerId=-1,this.mouseUp(a)}mouseDown(a){this.mouseUp(a);if(!a.button&&(!a.target||a.target===this.element||this.outsidePointerHandler&&this.outsidePointerHandler(a))){if(this.downCallback&&!this.downCallback(a))return cancelEvent(a);this._captured=!0;this.lazy&&
this.addSecondaryHandlers();return cancelEvent(a)}}mouseMove(a){if(this._captured)return this.moveCallback&&this.moveCallback(a),cancelEvent(a)}mouseUp(a){if(this._captured)return this._captured=!1,this.lazy&&this.removeSecondaryHandlers(),this.upCallback&&this.upCallback(a),cancelEvent(a)}}
class GraphicalFilterEditorStrings{static toFixed(a,b){return a.toFixed(b)}static init(a){a&&0===a.toLowerCase().indexOf("pt")&&(GraphicalFilterEditorStrings.Minus0="-0,00",GraphicalFilterEditorStrings.Curve="Curva: ",GraphicalFilterEditorStrings.Frequency="Frequ\u00eancia: ",GraphicalFilterEditorStrings.SameCurve="Mesma curva para ambos canais",GraphicalFilterEditorStrings.UseLeftCurve="Usar curva da esquerda",GraphicalFilterEditorStrings.UseRightCurve="Usar curva da direita",GraphicalFilterEditorStrings.OneForEach=
"Uma curva por canal",GraphicalFilterEditorStrings.ShowLeftCurve="Exibir curva da esquerda",GraphicalFilterEditorStrings.ShowRightCurve="Exibir curva da direita",GraphicalFilterEditorStrings.ResetCurve="Zerar curva",GraphicalFilterEditorStrings.EditMode="Modo de edi\u00e7\u00e3o",GraphicalFilterEditorStrings.Regular="Normal",GraphicalFilterEditorStrings.Zones="Zonas",GraphicalFilterEditorStrings.SmoothNarrow="Suave (estreito)",GraphicalFilterEditorStrings.SmoothWide="Suave (largo)",GraphicalFilterEditorStrings.PeakingEq=
'Filtro "Peaking" de 10 Bandas',GraphicalFilterEditorStrings.ShelfEq='Filtro "Low Shelf" de 7 Bandas',GraphicalFilterEditorStrings.NormalizeCurves="Normalizar curvas",GraphicalFilterEditorStrings.ShowZones="Exibir zonas",GraphicalFilterEditorStrings.ShowActualResponse="Exibir resposta real",GraphicalFilterEditorStrings.toFixed=function(b,c){return b.toFixed(c).replace(".",",")})}}GraphicalFilterEditorStrings.Minus0="-0.00";GraphicalFilterEditorStrings.Cursor="Cursor: ";
GraphicalFilterEditorStrings.Curve="Curve: ";GraphicalFilterEditorStrings.Frequency="Frequency: ";GraphicalFilterEditorStrings.SameCurve="Same curve for both channels";GraphicalFilterEditorStrings.UseLeftCurve="Use left curve";GraphicalFilterEditorStrings.UseRightCurve="Use right curve";GraphicalFilterEditorStrings.OneForEach="One curve for each channel";GraphicalFilterEditorStrings.ShowLeftCurve="Show left curve";GraphicalFilterEditorStrings.ShowRightCurve="Show right curve";
GraphicalFilterEditorStrings.ResetCurve="Reset curve";GraphicalFilterEditorStrings.EditMode="Edit mode";GraphicalFilterEditorStrings.Regular="Regular";GraphicalFilterEditorStrings.Zones="Zones";GraphicalFilterEditorStrings.SmoothNarrow="Smooth (narrow)";GraphicalFilterEditorStrings.SmoothWide="Smooth (wide)";GraphicalFilterEditorStrings.PeakingEq="10-band Peaking Filter";GraphicalFilterEditorStrings.ShelfEq="7-band Low Shelf Filter";GraphicalFilterEditorStrings.NormalizeCurves="Normalize curves";
GraphicalFilterEditorStrings.ShowZones="Show zones";GraphicalFilterEditorStrings.ShowActualResponse="Show actual response";GraphicalFilterEditorStrings.MinusInfinity="-Inf.";var GraphicalFilterEditorIIRType;(function(a){a[a.None=0]="None";a[a.Peaking=1]="Peaking";a[a.Shelf=2]="Shelf"})(GraphicalFilterEditorIIRType||(GraphicalFilterEditorIIRType={}));
class Filter{constructor(a){this.source=null;this.filterChangedCallback=a}connectSourceAndDestination(a,b){a=this.connectSourceToInput(a);return this.connectOutputToDestination(b)&&a}disconnectSourceAndDestination(){const a=this.disconnectSourceFromInput();return this.disconnectOutputFromDestination()&&a}disconnectSourceFromInput(){return this.source?(this.source.disconnect(),this.source=null,!0):!1}connectSourceToInput(a){this.disconnectSourceFromInput();if(this.source=a){a.disconnect();const b=
this.inputNode;if(b)return a.connect(b,0,0),!0}return!1}connectOutputToDestination(a){const b=this.outputNode;return b?(b.disconnect(),a&&b.connect(a,0,0),!0):!1}disconnectOutputFromDestination(){const a=this.outputNode;return a?(a.disconnect(),!0):!1}destroy(){this.disconnectSourceFromInput();this.disconnectOutputFromDestination()}}
class GraphicalFilterEditor extends Filter{constructor(a,b,c,d){super(c);if(8>a||a&a-1)throw"Sorry, class available only for fft sizes that are a power of 2 >= 8! :(";this.filterLength=a;this._sampleRate=b.sampleRate?b.sampleRate:44100;this._isNormalized=!1;this._iirType=d||GraphicalFilterEditorIIRType.None;this.binCount=(a>>>1)+1;this.filterKernel=b.createBuffer(2,a,this._sampleRate);this.audioContext=b;this.editorPtr=cLib._graphicalFilterEditorAlloc(this.filterLength,this._sampleRate);a=cLib.HEAP8.buffer;
this.filterKernelBuffer=new Float32Array(a,cLib._graphicalFilterEditorGetFilterKernelBuffer(this.editorPtr),GraphicalFilterEditor.maximumFilterLength);this.channelCurves=[new Int32Array(a,cLib._graphicalFilterEditorGetChannelCurve(this.editorPtr,0),GraphicalFilterEditor.visibleBinCount),new Int32Array(a,cLib._graphicalFilterEditorGetChannelCurve(this.editorPtr,1),GraphicalFilterEditor.visibleBinCount)];this.actualChannelCurve=new Int32Array(a,cLib._graphicalFilterEditorGetActualChannelCurve(this.editorPtr),
GraphicalFilterEditor.visibleBinCount);this.visibleFrequencies=new Float64Array(a,cLib._graphicalFilterEditorGetVisibleFrequencies(this.editorPtr),GraphicalFilterEditor.visibleBinCount);this.equivalentZones=new Int32Array(a,cLib._graphicalFilterEditorGetEquivalentZones(this.editorPtr),GraphicalFilterEditor.equivalentZoneCount);this.equivalentZonesFrequencyCount=new Int32Array(a,cLib._graphicalFilterEditorGetEquivalentZonesFrequencyCount(this.editorPtr),GraphicalFilterEditor.equivalentZoneCount+1);
this.curveSnapshot=this.biquadFilterActualPhase=this.biquadFilterActualMag=this.biquadFilterActualAccum=this.biquadFilterActualFrequencies=this.biquadFilterActualGains=this.biquadFilterGains=this.biquadFilterOutput=this.biquadFilterInput=this.biquadFilters=this._convolver=null;this.updateFilter(0,!0,!0);this.updateActualChannelCurve(0);this.updateBuffer();this.filterChangedCallback=c}static encodeCurve(a){const b=GraphicalFilterEditor.minimumChannelValueY,c=GraphicalFilterEditor.validYRangeHeight,
d=a.length,e=Array(d<<1);let g=0;for(let f=0;f<d;f++){let h=a[f];h=h>b?0:c-h;254>=h?e[g++]=h:(e[g++]=255,e[g++]=h-254)}e.splice(g);return btoa(String.fromCharCode(...e))}static decodeCurve(a){if(!a||a.length<4*GraphicalFilterEditor.visibleBinCount/3)return null;try{a=atob(a)}catch(g){return null}if(a.length<GraphicalFilterEditor.visibleBinCount)return null;const b=GraphicalFilterEditor.validYRangeHeight,c=a.length,d=Array(GraphicalFilterEditor.visibleBinCount);let e=0;for(let g=0;g<c;g++){const f=
a.charCodeAt(g);254>=f?d[e++]=b-f:g<c-1&&(g++,d[e++]=b-(a.charCodeAt(g)+254))}return d}get sampleRate(){return this._sampleRate}get isNormalized(){return this._isNormalized}get iirType(){return this._iirType}get convolver(){return this._convolver}get inputNode(){return this.biquadFilterInput||this._convolver}get outputNode(){return this.biquadFilterOutput||this._convolver}destroy(){this.editorPtr&&(super.destroy(),cLib._graphicalFilterEditorFree(this.editorPtr),zeroObject(this))}clampX(a){return 0>=
a?0:a>=GraphicalFilterEditor.visibleBinCount?GraphicalFilterEditor.visibleBinCount-1:a}clampY(a){return a<=GraphicalFilterEditor.maximumChannelValueY?GraphicalFilterEditor.maximumChannelValueY:a>GraphicalFilterEditor.minimumChannelValueY?GraphicalFilterEditor.validYRangeHeight+1:a}dBToMagnitude(a){return Math.pow(10,a/20)}yToDB(a){return a<=GraphicalFilterEditor.maximumChannelValueY?40:a>GraphicalFilterEditor.minimumChannelValueY?-Infinity:lerp(GraphicalFilterEditor.maximumChannelValueY,40,GraphicalFilterEditor.minimumChannelValueY,
-40,a)}yToMagnitude(a){return a<=GraphicalFilterEditor.maximumChannelValueY?100:a>GraphicalFilterEditor.minimumChannelValueY?0:Math.exp(lerp(GraphicalFilterEditor.maximumChannelValueY,2,GraphicalFilterEditor.minimumChannelValueY,-2,a)*Math.LN10)}magnitudeToY(a){return 100<=a?GraphicalFilterEditor.maximumChannelValueY:.009>a?GraphicalFilterEditor.validYRangeHeight+1:Math.round(GraphicalFilterEditor.zeroChannelValueY-GraphicalFilterEditor.zeroChannelValueY*Math.log(a)/Math.LN10*.5-.4)}visibleBinToZoneIndex(a){if(a>=
GraphicalFilterEditor.visibleBinCount-1)return this.equivalentZones.length-1;if(0<a){const b=this.equivalentZonesFrequencyCount;for(let c=b.length-1;0<=c;c--)if(a>=b[c])return c}return 0}visibleBinToFrequency(a,b){const c=this.equivalentZones,d=this.visibleFrequencies;var e=GraphicalFilterEditor.visibleBinCount;if(a>=e-1)return b?[d[e-1],c[c.length-1]]:d[e-1];if(0<a)if(b){e=this.equivalentZonesFrequencyCount;for(let g=e.length-1;0<=g;g--)if(a>=e[g])return[d[a],c[g]]}else return d[a];return b?[d[0],
c[0]]:d[0]}getZoneY(a,b){0>b?b=0:b>=this.equivalentZones.length&&(b=this.equivalentZones.length-1);return this.channelCurves[a][this.equivalentZonesFrequencyCount[b]]}changeZoneY(a,b,c){b=this.visibleBinToZoneIndex(b);const d=this.equivalentZonesFrequencyCount[b+1];c=this.clampY(c);a=this.channelCurves[a];for(b=this.equivalentZonesFrequencyCount[b];b<d;b++)a[b]=c}changeZoneYByIndex(a,b,c){0>b?b=0:b>=this.equivalentZones.length&&(b=this.equivalentZones.length-1);const d=this.equivalentZonesFrequencyCount[b+
1];c=this.clampY(c);a=this.channelCurves[a];for(b=this.equivalentZonesFrequencyCount[b];b<d;b++)a[b]=c}changeShelfZoneYByRegularIndex(a,b,c){switch(b){case 0:case 1:this.changeZoneYByIndex(a,0,c);this.changeZoneYByIndex(a,1,c);break;case 4:case 5:this.changeZoneYByIndex(a,4,c);this.changeZoneYByIndex(a,5,c);break;case 6:case 7:this.changeZoneYByIndex(a,6,c);this.changeZoneYByIndex(a,7,c);break;default:this.changeZoneYByIndex(a,b,c)}}getShelfZoneY(a,b){0>b?b=0:b>=GraphicalFilterEditor.shelfEquivalentZoneCount&&
(b=GraphicalFilterEditor.shelfEquivalentZoneCount-1);return this.channelCurves[a][this.equivalentZonesFrequencyCount[GraphicalFilterEditor.shelfEquivalentZones[b]]]}changeShelfZoneY(a,b,c){this.changeShelfZoneYByRegularIndex(a,this.visibleBinToZoneIndex(b),c)}changeShelfZoneYByIndex(a,b,c){0>b?b=0:b>=GraphicalFilterEditor.shelfEquivalentZoneCount&&(b=GraphicalFilterEditor.shelfEquivalentZoneCount-1);this.changeShelfZoneYByRegularIndex(a,GraphicalFilterEditor.shelfEquivalentZones[b],c)}startSmoothEdition(a){this.curveSnapshot||
(this.curveSnapshot=new Int32Array(GraphicalFilterEditor.visibleBinCount));this.curveSnapshot.set(this.channelCurves[a])}changeSmoothY(a,b,c,d){var e=this.curveSnapshot;if(e){var g=GraphicalFilterEditor.visibleBinCount;c=this.clampY(c);a=this.channelCurves[a];a.set(e);d>>=1;for(let f=b-d,h=Math.min(b,g),k=Math.max(0,f);k<h;k++)e=512*smoothStep(f,b,k)|0,a[k]=this.clampY(Math.round((c*e+a[k]*(512-e))/512));for(let f=b+d,h=Math.min(f,g),k=Math.max(0,b);k<h;k++)d=512*smoothStep(f,b,k)|0,a[k]=this.clampY(Math.round((c*
d+a[k]*(512-d))/512))}}updateBuffer(){const a=this._convolver;this._convolver||(this._convolver=this.audioContext.createConvolver(),this._convolver.normalize=!1);this._convolver.buffer=this.filterKernel;!a&&this.filterChangedCallback&&this.filterChangedCallback()}copyToChannel(a,b){if(this.filterKernel.copyToChannel)this.filterKernel.copyToChannel(a,b);else{b=this.filterKernel.getChannelData(b);for(let c=this.filterLength-1;0<=c;c--)b[c]=a[c]}}copyFromChannel(a,b){if(this.filterKernel.copyToChannel)this.filterKernel.copyFromChannel(a,
b);else{b=this.filterKernel.getChannelData(b);for(let c=this.filterLength-1;0<=c;c--)a[c]=b[c]}}copyFilter(a,b){this.copyToChannel(this.filterKernel.getChannelData(a),b);this.updateBuffer()}updateFilter(a,b,c){switch(this._iirType){case GraphicalFilterEditorIIRType.Peaking:this.updatePeakingEq(a);return;case GraphicalFilterEditorIIRType.Shelf:this.updateShelfEq(a);return}cLib._graphicalFilterEditorUpdateFilter(this.editorPtr,a,this._isNormalized);this.copyToChannel(this.filterKernelBuffer,a);b?this.copyFilter(a,
1-a):c?this.updateFilter(1-a,!1,!1):this.updateBuffer()}updateActualChannelCurve(a){this._iirType?this.updateActualChannelCurveIIR():(this.copyFromChannel(this.filterKernelBuffer,a),cLib._graphicalFilterEditorUpdateActualChannelCurve(this.editorPtr,a))}updatePeakingEq(a){var b=this.audioContext;const c=this.channelCurves[a],d=this.equivalentZones,e=this.equivalentZonesFrequencyCount;a=GraphicalFilterEditor.equivalentZoneCount;let g=this.biquadFilters,f=this.biquadFilterGains,h=!1;if(!g||!f){h=!0;
g=Array(a);f=Array(a);const m=Array(a);var k=.5*Math.log(2),l=this.audioContext.sampleRate;const q=2*Math.PI;for(let n=a-1;0<=n;n--){const p=q*d[n]/l;m[n]=1/(2*Math.sinh(p/Math.sin(p)*k))}for(k=a-1;0<=k;k--)l=b.createBiquadFilter(),l.type="peaking",l.frequency.value=d[k],l.Q.value=m[k],g[k]=l,k<a-1&&g[k+1].connect(g[k]);this.biquadFilters=g;this.biquadFilterInput=g[a-1];this.biquadFilterOutput=g[0]}for(b=a-1;0<=b;b--)f[b]=Math.max(-40,this.yToDB(c[e[b]]));for(b=a-1;0<=b;b--)g[b].gain.value=f[b]+(b<
a-1?-.15*f[b+1]:0)+(0<b?-.15*f[b-1]:0);h&&this.filterChangedCallback&&this.filterChangedCallback()}updateShelfEq(a){var b=this.audioContext,c=this.channelCurves[a],d=this.equivalentZonesFrequencyCount,e=GraphicalFilterEditor.shelfEquivalentZoneCount,g=GraphicalFilterEditor.shelfEquivalentZones;a=this.biquadFilters;let f=this.biquadFilterGains,h=this.biquadFilterActualGains;a&&f&&h||(a=Array(e),f=Array(e),h=Array(e),this.biquadFilters=a,this.biquadFilterGains=f,this.biquadFilterActualGains=h,a[e-1]=
b.createGain(),this.biquadFilterInput=a[e-1]);for(b=e-1;0<=b;b--)f[b]=Math.max(-40,this.yToDB(c[d[g[b]]]));--e;b=0;c=!1;d=a[e];d.gain.value=this.dBToMagnitude(f[e]);for(--e;0<=e;e--)g=b+(f[e]-f[e+1]),-22>g?(b=g+22,g=-22):22<g?(b=g-22,g=22):b=0,h[e]!==g?(c=!0,h[e]=g,a[e]&&a[e].disconnect(),d.disconnect(),g?(a[e]=this.createIIRFilter(e,g),d.connect(a[e]),d=a[e]):a[e]=null):a[e]&&(c&&(c=!1,d.connect(a[e])),d=a[e]);this.biquadFilterOutput!==d&&(this.biquadFilterOutput=d,this.filterChangedCallback&&this.filterChangedCallback())}createIIRFilter(a,
b){const c=this.audioContext;var d=c.sampleRate;switch(a){case 0:a=92.75;break;case 1:a=187.5;break;case 2:a=375;break;case 3:a=1500;break;case 4:a=6E3;break;default:a=12E3}b=Math.pow(10,b/40);a=6.283185307179586*a/d;d=Math.cos(a);a=1*Math.sqrt(b)*Math.sin(a)*Math.sqrt(-.5*(b+1/b)+2);return c.createIIRFilter([b*(b+1-(b-1)*d+a),2*b*(b-1-(b+1)*d),b*(b+1-(b-1)*d-a)],[b+1+(b-1)*d+a,-2*(b-1+(b+1)*d),b+1+(b-1)*d-a])}updateActualChannelCurveIIR(){var a=this.biquadFilters;if(a){var b=this.biquadFilterActualFrequencies,
c=this.biquadFilterActualAccum,d=this.biquadFilterActualMag,e=this.biquadFilterActualPhase;if(!(b&&c&&d&&e)){e=this.visibleFrequencies;b=new Float32Array(e.length);for(c=e.length-1;0<=c;c--)b[c]=e[c];c=new Float32Array(e.length);d=new Float32Array(e.length);e=new Float32Array(e.length);this.biquadFilterActualFrequencies=b;this.biquadFilterActualAccum=c;this.biquadFilterActualMag=d;this.biquadFilterActualPhase=e}var g=b.length;if(this._iirType===GraphicalFilterEditorIIRType.Shelf)c.fill(a[a.length-
1].gain.value);else{a[a.length-1].getFrequencyResponse(b,c,e);for(var f=g-1,h=1;0<=f&&isNaN(h=c[f]);)f--;for(f++;f<g;)c[f++]=h}for(f=a.length-2;0<=f;f--)if(a[f]){a[f].getFrequencyResponse(b,d,e);for(let k=0,l=0;k<g;k++)h=d[k],isNaN(h)||(l=h),c[k]*=l}a=this.actualChannelCurve;b=this.magnitudeToY;for(d=a.length-1;0<=d;d--)a[d]=b(c[d])}}changeFilterLength(a,b,c){return this.filterLength!==a?(this.filterLength=a,this.binCount=(a>>>1)+1,this.filterKernel=this.audioContext.createBuffer(2,a,this._sampleRate),
cLib._graphicalFilterEditorChangeFilterLength(this.editorPtr,a),this.updateFilter(b,c,!0),!0):!1}changeSampleRate(a,b,c){return this._sampleRate!==a?(this._sampleRate=a,this.filterKernel=this.audioContext.createBuffer(2,this.filterLength,a),this.updateFilter(b,c,!0),!0):!1}changeIsNormalized(a,b,c){return!this._isNormalized!==!a?(this._isNormalized=!!a,this.updateFilter(b,c,!0),!0):!1}changeIIRType(a,b,c){if(this._iirType!==a){this._iirType=a;this.disconnectOutputFromDestination();this._convolver=
null;if(a=this.biquadFilters){for(let d=a.length-1;0<=d;d--)a[d]&&a[d].disconnect();a.fill(null);this.biquadFilters=null}this.biquadFilterActualPhase=this.biquadFilterActualMag=this.biquadFilterActualAccum=this.biquadFilterActualFrequencies=this.biquadFilterGains=this.biquadFilterOutput=this.biquadFilterInput=null;this.updateFilter(b,c,!0);return!0}return!1}changeAudioContext(a,b,c){if(this.audioContext!==a){this.disconnectOutputFromDestination();this._convolver=null;const d=this.biquadFilters;if(d){for(let e=
d.length-1;0<=e;e--)d[e]&&d[e].disconnect();d.fill(null);this.biquadFilters=null}this.biquadFilterActualPhase=this.biquadFilterActualMag=this.biquadFilterActualAccum=this.biquadFilterActualFrequencies=this.biquadFilterGains=this.biquadFilterOutput=this.biquadFilterInput=null;this.audioContext=a;this._sampleRate=a.sampleRate?a.sampleRate:44100;this.filterKernel=a.createBuffer(2,this.filterLength,this._sampleRate);this.updateFilter(b,c,!0);this.updateBuffer();return!0}return!1}}
GraphicalFilterEditor.visibleBinCount=500;GraphicalFilterEditor.validYRangeHeight=321;GraphicalFilterEditor.zeroChannelValueY=GraphicalFilterEditor.validYRangeHeight>>>1;GraphicalFilterEditor.maximumChannelValue=GraphicalFilterEditor.zeroChannelValueY;GraphicalFilterEditor.minimumChannelValue=-GraphicalFilterEditor.zeroChannelValueY;GraphicalFilterEditor.minusInfiniteChannelValue=GraphicalFilterEditor.minimumChannelValue-1;GraphicalFilterEditor.maximumChannelValueY=0;
GraphicalFilterEditor.minimumChannelValueY=GraphicalFilterEditor.validYRangeHeight-1;GraphicalFilterEditor.maximumFilterLength=8192;GraphicalFilterEditor.equivalentZoneCount=10;GraphicalFilterEditor.shelfEquivalentZoneCount=7;GraphicalFilterEditor.shelfEquivalentZones=[0,2,3,4,6,8,9];class GraphicalFilterEditorRenderer{constructor(a,b,c){this.element=a;this.leftMargin=b;this.editor=c}destroy(){zeroObject(this)}}
class GraphicalFilterEditorCanvasRenderer extends GraphicalFilterEditorRenderer{constructor(a){super(document.createElement("canvas"),Math.abs(GraphicalFilterEditorControl.controlWidth-GraphicalFilterEditor.visibleBinCount)>>1,a);this.element.className="GECV";this.pixelRatio=1;this.rangeImage=this.ctx=null;this.scaleChanged()}scaleChanged(){var a=this.element,b=this.editor;if(a&&b){var c=GraphicalFilterEditorControl.controlWidth,d=GraphicalFilterEditorControl.controlHeight,e=1<devicePixelRatio?devicePixelRatio:
1;b=b.scale;var g=b*e;a.width=c*g|0;a.height=d*g|0;a.style.width=(c*b|0)+"px";a.style.height=(d*b|0)+"px";c=this.element.getContext("2d",{alpha:!1});if(!c)throw Error("Null canvas context");a=c.createLinearGradient(0,0,1,a.height);a.addColorStop(0,"#ff0000");a.addColorStop(.1875,"#ffff00");a.addColorStop(.39453125,"#00ff00");a.addColorStop(.60546875,"#00ffff");a.addColorStop(.796875,"#0000ff");a.addColorStop(1,"#ff00ff");this.pixelRatio=e;this.ctx=c;this.rangeImage=a}}drawCurve(a,b,c){const d=this.ctx;
if(d){var e=1<devicePixelRatio?devicePixelRatio:1;e!==this.pixelRatio&&(this.scaleChanged(),e=this.pixelRatio);var g=this.editor,f=g.filter;e*=g.scale;var h=this.element;g=this.leftMargin;var k=h.width,l=h.height,m=Math.round(8*e),q=Math.round(4*e),n=(k/m|0)+1,p=GraphicalFilterEditor.maximumChannelValueY*e|0,r=1>e?e:e|0;h=.5*r;d.fillStyle="#303030";d.fillRect(0,0,k,l);d.lineWidth=r;d.strokeStyle="#5a5a5a";d.beginPath();r=k+(q>>1);var u=(GraphicalFilterEditor.zeroChannelValueY*e|0)+h;d.moveTo(r,u);
for(let t=n-1;0<=t;t--)d.lineTo(r-q,u),r-=m,d.moveTo(r,u);d.stroke();d.beginPath();r=k+(q>>1);u=(GraphicalFilterEditor.validYRangeHeight*e|0)+h;d.moveTo(r,u);for(k=n-1;0<=k;k--)d.lineTo(r-q,u),r-=m,d.moveTo(r,u);d.stroke();if(a)for(a=f.equivalentZonesFrequencyCount.length-2;0<a;a--){r=((f.equivalentZonesFrequencyCount[a]+g)*e|0)+h;u=p;d.beginPath();for(d.moveTo(r,u);u<l;)d.lineTo(r,u+q),u+=m,d.moveTo(r,u);d.stroke()}r=1>e?2*e:2*e|0;h=.5*r;d.lineWidth=r;a=GraphicalFilterEditor.visibleBinCount-1;for(l=
b?1:0;0<=l;l--){m=l||!b?f.channelCurves[c]:f.actualChannelCurve;d.strokeStyle=l?"#707070":this.rangeImage;d.beginPath();d.moveTo(g*e|0,m[0]*e+h);for(r=1;r<a;r++)d.lineTo((g+r)*e|0,m[r]*e+h);d.lineTo((g+r+1)*e|0,m[r]*e+h);d.stroke()}}}}
class GraphicalFilterEditorSVGRenderer extends GraphicalFilterEditorRenderer{constructor(a){super(document.createElement("div"),Math.abs(GraphicalFilterEditorControl.controlWidth-GraphicalFilterEditor.visibleBinCount)>>1,a);this.element.className="GECV";this.element.style.overflow="hidden";this.element.style.backgroundColor="#303030";this.element.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1" viewBox="0 0 1 1" version="1.1" style="transform-origin: top left; pointer-events: none;">\n\t\t\t<defs>\n\t\t\t\t<linearGradient id="editorSVGLinearGradient" x1="0" y1="0" x2="0" y2="1" gradientUnits="userSpaceOnUse">\n\t\t\t\t\t<stop offset="0" stop-color="#ff0000" />\n\t\t\t\t\t<stop offset="0.1875" stop-color="#ffff00" />\n\t\t\t\t\t<stop offset="0.39453125" stop-color="#00ff00" />\n\t\t\t\t\t<stop offset="0.60546875" stop-color="#00ffff" />\n\t\t\t\t\t<stop offset="0.796875" stop-color="#0000ff" />\n\t\t\t\t\t<stop offset="1" stop-color="#ff00ff" />\n\t\t\t\t</linearGradient>\n\t\t\t</defs>\n\t\t\t<line x1="0" y1="0" x2="1" y2="0" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t<line x1="0" y1="0" x2="1" y2="0" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t<g style="display:none">\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t\t<line x1="0" y1="0" x2="0" y2="1" stroke="#5a5a5a" stroke-width="1px" stroke-dasharray="4" />\n\t\t\t</g>\n\t\t\t<path style="fill:none;stroke:#707070;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter" d="M 0,0 1,0" />\n\t\t\t<path style="fill:none;stroke:url(#editorSVGLinearGradient);stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter" d="M 0,0 1,0" />\n\t\t</svg>';
this.pixelRatio=1;this.showZones=!1;this.isActualChannelCurveNeeded=!0;this.svg=a=this.element.firstChild;this.svgGradient=a.getElementsByTagName("linearGradient")[0];this.svgZones=a.getElementsByTagName("g")[0];var b=a.getElementsByTagName("path");this.svgGrayCurve=b[0];this.svgCurve=b[1];a=a.getElementsByTagName("line");this.svgLines=Array(a.length);for(b=a.length-1;0<=b;b--)this.svgLines[b]=a[b];this.scaleChanged()}scaleChanged(){const a=this.element;var b=this.editor,c=b.filter;const d=this.svg;
if(a&&b&&c&&d){var e=GraphicalFilterEditorControl.controlWidth,g=GraphicalFilterEditorControl.controlHeight,f=1<devicePixelRatio?devicePixelRatio:1,h=b.scale;b=h*f;var k=this.leftMargin,l=this.svgLines,m=1>b?b:b|0,q=.5*m,n=(e*b|0).toString(),p=(g*b|0).toString();d.setAttribute("width",n);d.setAttribute("height",p);d.setAttribute("viewBox",`0 0 ${n} ${p}`);d.style.transform=1===f?"":"scale("+1/f+")";this.svgGradient.setAttribute("y2",p);a.style.width=(e*h|0)+"px";a.style.height=(g*h|0)+"px";l[0].setAttribute("x2",
n);l[1].setAttribute("x2",n);for(n=l.length-1;2<=n;n--)l[n].setAttribute("y2",p);p=((GraphicalFilterEditor.zeroChannelValueY*b|0)+q).toString();l[0].setAttribute("y1",p);l[0].setAttribute("y2",p);p=((GraphicalFilterEditor.validYRangeHeight*b|0)+q).toString();l[1].setAttribute("y1",p);l[1].setAttribute("y2",p);for(p=c.equivalentZonesFrequencyCount.length-2;0<p;p--)n=(((c.equivalentZonesFrequencyCount[p]+k)*b|0)+q).toString(),l[p+1].setAttribute("x1",n),l[p+1].setAttribute("x2",n);n=m.toString()+"px";
p=(4*b|0).toString();for(c=l.length-1;0<=c;c--)l[c].setAttribute("stroke-width",n),l[c].setAttribute("stroke-dasharray",p);n=(1>b?2*b:2*b|0).toString()+"px";this.svgGrayCurve.style.strokeWidth=n;this.svgCurve.style.strokeWidth=n;this.pixelRatio=f}}drawCurve(a,b,c){var d=1<devicePixelRatio?devicePixelRatio:1;d!==this.pixelRatio&&(this.scaleChanged(),d=this.pixelRatio);this.showZones!==a&&(this.showZones=a,this.svgZones.style.display=a?"":"none");var e=this.editor;a=e.filter;d*=e.scale;e=.5*(1>d?2*
d:2*d|0);const g=this.leftMargin,f=GraphicalFilterEditor.visibleBinCount;for(let h=b?1:0;0<=h;h--){const k=h||!b?a.channelCurves[c]:a.actualChannelCurve,l=h?this.svgGrayCurve:this.svgCurve;let m=1,q=0,n=k[0],p="M "+(g*d|0)+","+(n*d+e);for(;m<f;m++)k[m]!==n&&(m>q+1&&1<m&&(p+=" "+((g+m-1)*d|0)+","+(k[m-1]*d+e)),q=m,n=k[m],p+=" "+((g+q)*d|0)+","+(n*d+e));p+=" "+((g+m)*d|0)+","+(k[m-1]*d+e);l.setAttribute("d",p)}this.isActualChannelCurveNeeded!==b&&(this.isActualChannelCurveNeeded=b,this.svgGrayCurve.style.display=
b?"":"none")}}
class GraphicalFilterEditorControl{constructor(a,b,c,d,e,g){this._showZones=!1;this._editMode=GraphicalFilterEditorControl.editModeRegular;this._isActualChannelCurveNeeded=!0;this._currentChannelIndex=0;this.isSameFilterLR=!0;this.drawOffsetY=this.drawOffsetX=this.lastDrawY=this.lastDrawX=this.drawingMode=0;if(8>b||b&b-1)throw"Sorry, class available only for fft sizes that are a power of 2 >= 8! :(";this.filter=new GraphicalFilterEditor(b,c,d);b=()=>{const h=document.createElement("div");h.className=
"GEMNUSEP";return h};c=h=>{const k=document.createElement("div");k.className="GEMNULBL";k.appendChild(document.createTextNode(h));return k};d=(h,k,l,m,q,n)=>{const p=document.createElement("div");p.className=n?"GEMNUIT GECLK "+n:"GEMNUIT GECLK";if(k)if(g&&(m&&g.radioHTML||!m&&g.checkHTML))p.innerHTML=m?g.radioHTML:g.checkHTML,k=p.firstChild,k.style.marginRight=m?g.radioMargin||"2px":g.checkMargin||"2px",l||(k.style.visibility="hidden");else{k=document.createElement("span");n=m?"\u25cf ":"\u25a0 ";
let r=null;if(g){let u=!1;m?g.radioCharacter&&(u=!0,n=g.radioCharacter,r=g.radioMargin||"2px"):g.checkCharacter&&(u=!0,n=g.checkCharacter,r=g.checkMargin||"2px");u&&(g.checkFontFamily&&(k.style.fontFamily=g.checkFontFamily),g.checkFontSize&&(k.style.fontSize=g.checkFontSize))}r&&(k.style.marginRight=r);k.appendChild(document.createTextNode(n));l||(k.style.visibility="hidden");p.appendChild(k)}p.appendChild(document.createTextNode(h));q&&(p.onclick=q);return p};this.element=a;a.className="GE";this.boundMouseMove=
this.mouseMove.bind(this);this._scale=0;this.scale=g&&g.scale&&0<g.scale?g.scale:1;this.renderer=g&&g.svgRenderer?new GraphicalFilterEditorSVGRenderer(this):new GraphicalFilterEditorCanvasRenderer(this);this.renderer.element.addEventListener("mousemove",this.boundMouseMove);this.renderer.element.oncontextmenu=cancelEvent;a.appendChild(this.renderer.element);this.pointerHandler=new PointerHandler(this.renderer.element,this.mouseDown.bind(this),this.mouseMove.bind(this),this.mouseUp.bind(this));a.oncontextmenu=
cancelEvent;var f=document.createElement("div");f.className="GELBL";f.style.width="9em";f.appendChild(document.createTextNode(GraphicalFilterEditorStrings.Cursor));f.appendChild(this.lblCursor=document.createElement("span"));f.appendChild(document.createTextNode(" dB"));this.lblCursor.appendChild(document.createTextNode(GraphicalFilterEditorStrings.Minus0));a.appendChild(f);f=document.createElement("div");f.className="GELBL";f.style.width="9em";f.appendChild(document.createTextNode(GraphicalFilterEditorStrings.Curve));
f.appendChild(this.lblCurve=document.createElement("span"));f.appendChild(document.createTextNode(" dB"));this.lblCurve.appendChild(document.createTextNode(GraphicalFilterEditorStrings.Minus0));a.appendChild(f);f=document.createElement("div");f.className="GELBL";f.appendChild(document.createTextNode(GraphicalFilterEditorStrings.Frequency));f.appendChild(this.lblFrequency=document.createElement("span"));this.lblFrequency.appendChild(document.createTextNode("0 Hz (31 Hz)"));a.appendChild(f);this.btnMnu=
document.createElement("div");this.btnMnu.className="GEBTN GECLK";this.openMenuElement=null;this.openMenuCharacter="\u25b2";this.closeMenuElement=null;this.closeMenuCharacter="\u25bc";g&&(f=!1,g.openMenuHTML&&g.closeMenuHTML?(f=!0,this.btnMnu.innerHTML=g.openMenuHTML+g.closeMenuHTML,this.openMenuElement=this.btnMnu.childNodes[0],this.closeMenuElement=this.btnMnu.childNodes[1],this.closeMenuElement.style.display="none"):g.openMenuCharacter?(f=!0,this.openMenuCharacter=g.openMenuCharacter,this.closeMenuCharacter=
g.closeMenuCharacter||this.openMenuCharacter):g.closeMenuCharacter&&(f=!0,this.closeMenuCharacter=this.openMenuCharacter=g.closeMenuCharacter),f&&(g.menuFontFamily&&(this.btnMnu.style.fontFamily=g.menuFontFamily),g.menuFontSize&&(this.btnMnu.style.fontSize=g.menuFontSize),g.menuWidth&&(this.btnMnu.style.width=g.menuWidth),g.menuPadding&&(this.btnMnu.style.padding=g.menuPadding)));this.openMenuElement||this.btnMnu.appendChild(document.createTextNode(this.openMenuCharacter));this.btnMnu.onclick=this.btnMnu_Click.bind(this);
a.appendChild(this.btnMnu);this.mnu=document.createElement("div");this.mnu.className="GEMNU";this.mnu.style.display="none";f=document.createElement("div");f.className="GEMNUH GEFILTER";f.appendChild(c(GraphicalFilterEditorStrings.SameCurve));f.appendChild(this.mnuChBL=d(GraphicalFilterEditorStrings.UseLeftCurve,!0,!0,!0,this.mnuChB_Click.bind(this,0)));f.appendChild(this.mnuChBR=d(GraphicalFilterEditorStrings.UseRightCurve,!0,!1,!0,this.mnuChB_Click.bind(this,1)));f.appendChild(b());f.appendChild(c(GraphicalFilterEditorStrings.OneForEach));
f.appendChild(this.mnuChL=d(GraphicalFilterEditorStrings.ShowLeftCurve,!0,!1,!0,this.mnuChLR_Click.bind(this,0)));f.appendChild(this.mnuChR=d(GraphicalFilterEditorStrings.ShowRightCurve,!0,!1,!0,this.mnuChLR_Click.bind(this,1)));this.mnu.appendChild(f);f=document.createElement("div");f.className="GEMNUH GEMNUSEPH";f.appendChild(d(GraphicalFilterEditorStrings.ResetCurve,!1,!1,!1,this.mnuResetCurve_Click.bind(this)));f.appendChild(b());f.appendChild(c(GraphicalFilterEditorStrings.EditMode));f.appendChild(this.mnuEditRegular=
d(GraphicalFilterEditorStrings.Regular,!0,!0,!0,this.mnuEditRegular_Click.bind(this)));f.appendChild(this.mnuEditZones=d(GraphicalFilterEditorStrings.Zones,!0,!1,!0,this.mnuEditZones_Click.bind(this)));f.appendChild(this.mnuEditSmoothNarrow=d(GraphicalFilterEditorStrings.SmoothNarrow,!0,!1,!0,this.mnuEditSmoothNarrow_Click.bind(this)));f.appendChild(this.mnuEditSmoothWide=d(GraphicalFilterEditorStrings.SmoothWide,!0,!1,!0,this.mnuEditSmoothWide_Click.bind(this)));f.appendChild(this.mnuEditPeakingEq=
d(GraphicalFilterEditorStrings.PeakingEq,!0,!1,!0,this.mnuEditPeakingEq_Click.bind(this)));g&&g.hideEditModePeakingEq&&(this.mnuEditPeakingEq.style.display="none");f.appendChild(this.mnuEditShelfEq=d(GraphicalFilterEditorStrings.ShelfEq,!0,!1,!0,this.mnuEditShelfEq_Click.bind(this)));g&&g.hideEditModeShelfEq&&(this.mnuEditShelfEq.style.display="none");f.appendChild(b());f.appendChild(this.mnuNormalizeCurves=d(GraphicalFilterEditorStrings.NormalizeCurves,!0,!1,!1,this.mnuNormalizeCurves_Click.bind(this),
"GEFILTER"));f.appendChild(this.mnuShowZones=d(GraphicalFilterEditorStrings.ShowZones,!0,!1,!1,this.mnuShowZones_Click.bind(this)));f.appendChild(this.mnuShowActual=d(GraphicalFilterEditorStrings.ShowActualResponse,!0,!0,!1,this.mnuShowActual_Click.bind(this)));this.mnu.appendChild(f);a.appendChild(this.mnu);e&&this.loadSettings(e);this.drawCurve()}destroy(){this.filter&&this.filter.destroy();this.pointerHandler&&this.pointerHandler.destroy();this.renderer&&this.renderer.destroy();zeroObject(this)}loadSettings(a){if(a){var b=
this.filter;if(!1===a.showZones||!0===a.showZones)this._showZones=a.showZones;a.editMode&&a.editMode>=GraphicalFilterEditorControl.editModeFirst&&a.editMode<=GraphicalFilterEditorControl.editModeLast&&(this._editMode=a.editMode);if(!1===a.isActualChannelCurveNeeded||!0===a.isActualChannelCurveNeeded)this._isActualChannelCurveNeeded=a.isActualChannelCurveNeeded;if(0===a.currentChannelIndex||1===a.currentChannelIndex)this._currentChannelIndex=a.currentChannelIndex;if(!1===a.isSameFilterLR||!0===a.isSameFilterLR)this.isSameFilterLR=
a.isSameFilterLR;var c=GraphicalFilterEditor.decodeCurve(a.leftCurve),d=GraphicalFilterEditor.decodeCurve(a.rightCurve);c&&!d?d=c:d&&!c&&(c=d);if(c){var e=b.channelCurves[0];for(let g=GraphicalFilterEditor.visibleBinCount-1;0<=g;g--)e[g]=b.clampY(c[g])}if(d)for(c=b.channelCurves[1],e=GraphicalFilterEditor.visibleBinCount-1;0<=e;e--)c[e]=b.clampY(d[e]);this.isSameFilterLR?(this.checkMenu(this.mnuChBL,0===this._currentChannelIndex),this.checkMenu(this.mnuChL,!1),this.checkMenu(this.mnuChBR,1===this._currentChannelIndex),
this.checkMenu(this.mnuChR,!1)):(this.checkMenu(this.mnuChBL,!1),this.checkMenu(this.mnuChL,0===this._currentChannelIndex),this.checkMenu(this.mnuChBR,!1),this.checkMenu(this.mnuChR,1===this._currentChannelIndex));a=!1===a.isNormalized||!0===a.isNormalized?a.isNormalized:b.isNormalized;a===b.isNormalized?b.updateFilter(this._currentChannelIndex,this.isSameFilterLR,!0):b.changeIsNormalized(a,this._currentChannelIndex,this.isSameFilterLR);this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex);
this.checkMenu(this.mnuShowZones,this._showZones);this.editMode=this._editMode;this.checkMenu(this.mnuNormalizeCurves,this.filter.isNormalized);this.checkMenu(this.mnuShowActual,this._isActualChannelCurveNeeded);this.drawCurve()}}saveSettings(){return{showZones:this._showZones,editMode:this._editMode,isActualChannelCurveNeeded:this._isActualChannelCurveNeeded,currentChannelIndex:this._currentChannelIndex,isSameFilterLR:this.isSameFilterLR,isNormalized:this.filter.isNormalized,leftCurve:GraphicalFilterEditor.encodeCurve(this.filter.channelCurves[0]),
rightCurve:GraphicalFilterEditor.encodeCurve(this.filter.channelCurves[1])}}get scale(){return this._scale}set scale(a){0>=a||this._scale===a||!this.element||(this._scale=a,this.element.style.fontSize=12*a+"px",this.element.style.lineHeight=16*a+"px",this.renderer&&(this.renderer.scaleChanged(),this.drawCurve()))}get showZones(){return this._showZones}set showZones(a){this._showZones=a;this.checkMenu(this.mnuShowZones,a);this.drawCurve()}get editMode(){return this._editMode}set editMode(a){if(!(a<
GraphicalFilterEditorControl.editModeFirst||a>GraphicalFilterEditorControl.editModeLast)){this._editMode=a;this.checkMenu(this.mnuEditRegular,a===GraphicalFilterEditorControl.editModeRegular);this.checkMenu(this.mnuEditZones,a===GraphicalFilterEditorControl.editModeZones);this.checkMenu(this.mnuEditSmoothNarrow,a===GraphicalFilterEditorControl.editModeSmoothNarrow);this.checkMenu(this.mnuEditSmoothWide,a===GraphicalFilterEditorControl.editModeSmoothWide);this.checkMenu(this.mnuEditPeakingEq,a===GraphicalFilterEditorControl.editModePeakingEq);
this.checkMenu(this.mnuEditShelfEq,a===GraphicalFilterEditorControl.editModeShelfEq);var b=GraphicalFilterEditorIIRType.None;switch(a){case GraphicalFilterEditorControl.editModePeakingEq:b=GraphicalFilterEditorIIRType.Peaking;break;case GraphicalFilterEditorControl.editModeShelfEq:b=GraphicalFilterEditorIIRType.Shelf}this.filter.iirType!==b&&(this.mnu.className=b?"GEMNU GEEQ":"GEMNU",this.filter.changeIIRType(b,this._currentChannelIndex,this.isSameFilterLR),this._isActualChannelCurveNeeded&&(this.filter.updateActualChannelCurve(this._currentChannelIndex),
this.drawCurve()))}}get isActualChannelCurveNeeded(){return this._isActualChannelCurveNeeded}set isActualChannelCurveNeeded(a){this._isActualChannelCurveNeeded=a;this.checkMenu(this.mnuShowActual,a);a&&this.filter.updateActualChannelCurve(this._currentChannelIndex);this.drawCurve()}get currentChannelIndex(){return this._currentChannelIndex}get isNormalized(){return this.filter.isNormalized}set isNormalized(a){this.filter.changeIsNormalized(a,this._currentChannelIndex,this.isSameFilterLR);this.checkMenu(this.mnuNormalizeCurves,
a);this._isActualChannelCurveNeeded&&(this.filter.updateActualChannelCurve(this._currentChannelIndex),this.drawCurve())}static formatDB(a){return-40>a?GraphicalFilterEditorStrings.MinusInfinity:0>a?GraphicalFilterEditorStrings.toFixed(a,2):0===a?GraphicalFilterEditorStrings.Minus0:"+"+GraphicalFilterEditorStrings.toFixed(a,2)}static formatFrequency(a){return a[0].toFixed(0)+" Hz ("+(1E3>a[1]?a[1]+" Hz":a[1]/1E3+" kHz")+")"}static setFirstNodeText(a,b){a.firstChild&&(a.firstChild.nodeValue=b)}btnMnu_Click(a){a.button||
("none"===this.mnu.style.display?(this.mnu.style.bottom=this.element.clientHeight-this.renderer.element.clientHeight+"px",this.mnu.style.display="inline-block",this.openMenuElement&&this.closeMenuElement?(this.openMenuElement.style.display="none",this.closeMenuElement.style.display=""):GraphicalFilterEditorControl.setFirstNodeText(this.btnMnu,this.closeMenuCharacter)):(this.mnu.style.display="none",this.openMenuElement&&this.closeMenuElement?(this.closeMenuElement.style.display="none",this.openMenuElement.style.display=
""):GraphicalFilterEditorControl.setFirstNodeText(this.btnMnu,this.openMenuCharacter)));return!0}checkMenu(a,b){a.firstChild.style.visibility=b?"visible":"hidden";return b}mnuChB_Click(a,b){b.button||this.isSameFilterLR&&this._currentChannelIndex===a||(this.isSameFilterLR?(this._currentChannelIndex=a,this.filter.updateFilter(a,!0,!0),this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(a),this.drawCurve()):(this.isSameFilterLR=!0,this.filter.copyFilter(a,1-a),this._currentChannelIndex!==
a&&(this._currentChannelIndex=a,this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(a),this.drawCurve())),this.checkMenu(this.mnuChBL,0===a),this.checkMenu(this.mnuChL,!1),this.checkMenu(this.mnuChBR,1===a),this.checkMenu(this.mnuChR,!1));return this.btnMnu_Click(b)}mnuChLR_Click(a,b){b.button||!this.isSameFilterLR&&this._currentChannelIndex===a||(this.isSameFilterLR&&(this.isSameFilterLR=!1,this.filter.updateFilter(1-this._currentChannelIndex,!1,!1)),this._currentChannelIndex!==
a&&(this._currentChannelIndex=a,this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(a),this.drawCurve()),this.checkMenu(this.mnuChBL,!1),this.checkMenu(this.mnuChL,0===a),this.checkMenu(this.mnuChBR,!1),this.checkMenu(this.mnuChR,1===a));return this.btnMnu_Click(b)}mnuResetCurve_Click(a){a.button||this.resetCurve();return this.btnMnu_Click(a)}mnuShowZones_Click(a){a.button||(this.showZones=!this._showZones);return this.btnMnu_Click(a)}mnuEditRegular_Click(a){a.button||(this.editMode=
GraphicalFilterEditorControl.editModeRegular);return this.btnMnu_Click(a)}mnuEditZones_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModeZones);return this.btnMnu_Click(a)}mnuEditSmoothNarrow_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModeSmoothNarrow);return this.btnMnu_Click(a)}mnuEditSmoothWide_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModeSmoothWide);return this.btnMnu_Click(a)}mnuEditPeakingEq_Click(a){a.button||(this.editMode=
GraphicalFilterEditorControl.editModePeakingEq);return this.btnMnu_Click(a)}mnuEditShelfEq_Click(a){a.button||(this.editMode=GraphicalFilterEditorControl.editModeShelfEq);return this.btnMnu_Click(a)}mnuNormalizeCurves_Click(a){a.button||(this.isNormalized=!this.filter.isNormalized);return this.btnMnu_Click(a)}mnuShowActual_Click(a){a.button||(this.isActualChannelCurveNeeded=!this._isActualChannelCurveNeeded);return this.btnMnu_Click(a)}mouseDown(a){if(!a.button&&!this.drawingMode){const b=this.renderer.element.getBoundingClientRect(),
c=((a.clientX-b.left)/this._scale|0)-this.renderer.leftMargin;a=(a.clientY-b.top)/this._scale|0;this.renderer.element.removeEventListener("mousemove",this.boundMouseMove);this.drawingMode=1;switch(this._editMode){case GraphicalFilterEditorControl.editModeZones:case GraphicalFilterEditorControl.editModePeakingEq:this.filter.changeZoneY(this._currentChannelIndex,c,a);break;case GraphicalFilterEditorControl.editModeShelfEq:this.filter.changeShelfZoneY(this._currentChannelIndex,c,a);break;case GraphicalFilterEditorControl.editModeSmoothNarrow:this.filter.startSmoothEdition(this._currentChannelIndex);
this.filter.changeSmoothY(this._currentChannelIndex,c,a,GraphicalFilterEditor.visibleBinCount>>3);break;case GraphicalFilterEditorControl.editModeSmoothWide:this.filter.startSmoothEdition(this._currentChannelIndex);this.filter.changeSmoothY(this._currentChannelIndex,c,a,GraphicalFilterEditor.visibleBinCount>>1);break;default:this.filter.channelCurves[this._currentChannelIndex][this.filter.clampX(c)]=this.filter.clampY(a),this.lastDrawX=c,this.lastDrawY=a}this.drawCurve();return!0}return!1}mouseMove(a){var b=
this.renderer.element.getBoundingClientRect();let c=((a.clientX-b.left)/this._scale|0)-this.renderer.leftMargin;a=(a.clientY-b.top)/this._scale|0;b=this.filter.channelCurves[this._currentChannelIndex];if(this.drawingMode){switch(this._editMode){case GraphicalFilterEditorControl.editModeZones:case GraphicalFilterEditorControl.editModePeakingEq:this.filter.changeZoneY(this._currentChannelIndex,c,a);break;case GraphicalFilterEditorControl.editModeShelfEq:this.filter.changeShelfZoneY(this._currentChannelIndex,
c,a);break;case GraphicalFilterEditorControl.editModeSmoothNarrow:this.filter.changeSmoothY(this._currentChannelIndex,c,a,GraphicalFilterEditor.visibleBinCount>>3);break;case GraphicalFilterEditorControl.editModeSmoothWide:this.filter.changeSmoothY(this._currentChannelIndex,c,a,GraphicalFilterEditor.visibleBinCount>>1);break;default:if(1<Math.abs(c-this.lastDrawX)){const d=(a-this.lastDrawY)/Math.abs(c-this.lastDrawX),e=c<this.lastDrawX?-1:1;let g=Math.abs(c-this.lastDrawX)-1;a=this.lastDrawY+d;for(c=
this.lastDrawX+e;0<g;c+=e,g--)b[this.filter.clampX(c)]=this.filter.clampY(a),a+=d}b[this.filter.clampX(c)]=this.filter.clampY(a);this.lastDrawX=c;this.lastDrawY=a}this.drawCurve()}else this._isActualChannelCurveNeeded&&(b=this.filter.actualChannelCurve);c=this.filter.clampX(c);GraphicalFilterEditorControl.setFirstNodeText(this.lblCursor,GraphicalFilterEditorControl.formatDB(this.filter.yToDB(a)));GraphicalFilterEditorControl.setFirstNodeText(this.lblCurve,GraphicalFilterEditorControl.formatDB(this.filter.yToDB(b[c])));
GraphicalFilterEditorControl.setFirstNodeText(this.lblFrequency,GraphicalFilterEditorControl.formatFrequency(this.filter.visibleBinToFrequency(c,!0)))}mouseUp(a){this.drawingMode&&(this.renderer.element.addEventListener("mousemove",this.boundMouseMove),this.drawingMode=0,this.commitChanges())}resetCurve(){const a=this.filter.channelCurves[this._currentChannelIndex];for(let b=a.length-1;0<=b;b--)a[b]=GraphicalFilterEditor.zeroChannelValueY;this.filter.updateFilter(this._currentChannelIndex,this.isSameFilterLR,
!1);this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex);this.drawCurve()}getZoneY(a){return this.filter.getZoneY(this._currentChannelIndex,a)}changeZoneY(a,b,c){this.filter.changeZoneYByIndex(this._currentChannelIndex,a,b);this.drawCurve(c)}getShelfZoneY(a){return this.filter.getShelfZoneY(this._currentChannelIndex,a)}changeShelfZoneY(a,b,c){this.filter.changeShelfZoneYByIndex(this._currentChannelIndex,a,b);this.drawCurve(c)}changeFilterY(a,b,c){this.filter.channelCurves[this._currentChannelIndex][this.filter.clampX(a)]=
this.filter.clampY(b);this.drawCurve(c)}commitChanges(){this.filter.updateFilter(this._currentChannelIndex,this.isSameFilterLR,!1);this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex);this.drawCurve()}changeFilterLength(a){return this.filter.changeFilterLength(a,this._currentChannelIndex,this.isSameFilterLR)?(this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex),this.drawCurve(),!0):!1}changeSampleRate(a){return this.filter.changeSampleRate(a,
this._currentChannelIndex,this.isSameFilterLR)?(this._isActualChannelCurveNeeded&&this.filter.updateActualChannelCurve(this._currentChannelIndex),this.drawCurve(),!0):!1}changeAudioContext(a){return this.filter.changeAudioContext(a,this._currentChannelIndex,this.isSameFilterLR)}drawCurve(a){this.renderer&&this.renderer.drawCurve(this._showZones,!a&&this._isActualChannelCurveNeeded&&!this.drawingMode,this._currentChannelIndex)}}GraphicalFilterEditorControl.controlWidth=Math.max(512,GraphicalFilterEditor.visibleBinCount);
GraphicalFilterEditorControl.controlHeight=GraphicalFilterEditor.validYRangeHeight+3;GraphicalFilterEditorControl.editModeRegular=0;GraphicalFilterEditorControl.editModeZones=1;GraphicalFilterEditorControl.editModeSmoothNarrow=2;GraphicalFilterEditorControl.editModeSmoothWide=3;GraphicalFilterEditorControl.editModePeakingEq=4;GraphicalFilterEditorControl.editModeShelfEq=5;GraphicalFilterEditorControl.editModeFirst=0;GraphicalFilterEditorControl.editModeLast=5;
class Program{constructor(a,b,c){const d=[];var e=[];const g=[];this.gl=a;var f=a.createProgram();if(!f)throw Error("Null program");this.program=f;f=a.createShader(a.VERTEX_SHADER);if(!f)throw Error("Null vertex shader");this.vs=f;f=a.createShader(a.FRAGMENT_SHADER);if(!f)throw Error("Null fragment shader");this.fs=f;a.shaderSource(this.vs,b);a.compileShader(this.vs);if(!a.getShaderParameter(this.vs,a.COMPILE_STATUS))throw e="Vertex shader: "+a.getShaderInfoLog(this.vs),this.destroy(),alert(e),e;
this.getAttribsAndUniforms(b,d,e,g);a.shaderSource(this.fs,c);a.compileShader(this.fs);if(!a.getShaderParameter(this.fs,a.COMPILE_STATUS))throw e="Fragment shader: "+a.getShaderInfoLog(this.fs),this.destroy(),alert(e),e;this.getAttribsAndUniforms(c,d,e,g);a.attachShader(this.program,this.vs);a.attachShader(this.program,this.fs);for(b=0;b<d.length;b++)a.bindAttribLocation(this.program,b,d[b]);a.linkProgram(this.program);for(a=0;a<e.length;a++)this.prepareUniform(e[a],g[a])}static create(a,b,c,d){const e=
["webkit-3d","moz-webgl","webgl","experimental-webgl"];for(let g=0;g<e.length;g++)try{const f=a.getContext(e[g],b);return new Program(f,c,d)}catch(f){}return null}getAttribsAndUniforms(a,b,c,d){a=a.split("\n");for(let l=0;l<a.length;l++){var e=a[l].trim();if("uniform"===e.substring(0,7)){e=e.split(" ");var g=e[1];for(var f=2;f<e.length;f++){var h=e[f];if(";"===h)break;var k=h.charAt(h.length-1);const m=";"===k;if(","===k||m)h=h.substring(0,h.length-1);","!==h&&h.length&&(c.push(h),d.push(g));if(m)break}}else if("attribute"===
e.substring(0,9))for(e=e.split(" "),g=2;g<e.length;g++){f=e[g];if(";"===f)break;h=f.charAt(f.length-1);k=";"===h;if(","===h||k)f=f.substring(0,f.length-1);","!==f&&f.length&&b.push(f);if(k)break}}}prepareUniform(a,b){const c=this.gl,d=c.getUniformLocation(this.program,a);if(!this[a])if("bool"===b||"int"===b||"sampler2D"===b)this[a]=function(e){c.uniform1i(d,e)};else if("float"===b)this[a]=function(e){c.uniform1f(d,e)};else if("vec2"===b)this[a]=function(e,g){c.uniform2f(d,e,g)},this[a+"v"]=function(e){c.uniform2fv(d,
e)};else if("vec3"===b)this[a]=function(e,g,f){c.uniform3f(d,e,g,f)},this[a+"v"]=function(e){c.uniform3fv(d,e)};else if("vec4"===b)this[a]=function(e,g,f,h){c.uniform4f(d,e,g,f,h)},this[a+"v"]=function(e){c.uniform4fv(d,e)};else if("mat4"===b)this[a]=function(e){c.uniformMatrix4fv(d,!1,e)};else return!1;return!0}use(){this.gl.useProgram(this.program)}destroy(){this.gl&&(this.gl.useProgram(null),this.vs&&(this.gl.detachShader(this.program,this.vs),this.gl.deleteShader(this.vs)),this.fs&&(this.gl.detachShader(this.program,
this.fs),this.gl.deleteShader(this.fs)),this.program&&this.gl.deleteProgram(this.program),zeroObject(this))}}
class Analyzer{constructor(a,b,c,d,e,g){this.alive=!1;this.lastRequest=0;this.boundAnalyze=null;this.audioContext=a;this.canvas=document.createElement("canvas");this.canvas.width=!e||0>=e?Analyzer.controlWidth:e;this.canvas.height=!g||0>=g?Analyzer.controlHeight:g;this.canvas.style.position="relative";this.canvas.style.margin="0px";this.canvas.style.padding="0px";this.canvas.style.verticalAlign="top";this.canvas.style.display="inline-block";this.canvas.style.cursor="default";c&&(this.canvas.id=c);
this.ctx=d?null:this.canvas.getContext("2d",{alpha:!1});b.appendChild(this.canvas);this.boundAnalyze=f=>{this.alive?(this.lastRequest=requestAnimationFrame(this.boundAnalyze),this.analyze(f)):this.lastRequest=0}}destroy(){this.stop();this.cleanUp();this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);zeroObject(this)}start(){if(this.alive)return!1;this.alive=!0;this.lastRequest=requestAnimationFrame(this.boundAnalyze);return!0}stop(){this.alive=!1;this.lastRequest&&
(cancelAnimationFrame(this.lastRequest),this.lastRequest=0)}}Analyzer.controlWidth=GraphicalFilterEditorControl.controlWidth;Analyzer.controlHeight=Analyzer.controlWidth;Analyzer.colors="#000000 #0B00B2 #0C00B1 #0E00AF #0E00AF #0F00AE #1000AD #1200AC #1300AB #1500AB #1600AA #1700A9 #1900A8 #1A00A6 #1B00A6 #1D00A4 #1F00A3 #2000A1 #2200A1 #2300A0 #25009E #27009D #29009C #2B009A #2D0099 #2E0098 #300096 #320095 #340094 #360092 #380090 #39008F #3C008E #3E008C #40008B #420089 #440088 #470086 #480085 #4B0083 #4C0082 #4F0080 #51007F #54007C #56007C #57007A #5A0078 #5C0076 #5F0075 #610073 #640071 #65006F #68006E #6B006C #6D006A #6F0069 #710066 #740065 #760063 #790062 #7B0060 #7D005E #80005C #82005B #850059 #860057 #890056 #8C0054 #8E0052 #910050 #93004F #96004D #97004B #9A0049 #9C0048 #9F0046 #A10045 #A40043 #A60040 #A8003F #AA003E #AD003C #AF003A #B10039 #B30037 #B60035 #B80034 #BA0032 #BC0031 #BE002E #C1002D #C3002C #C5002A #C70028 #CA0027 #CB0025 #CE0024 #CF0023 #D10022 #D30020 #D6001E #D7001D #D9001B #DB001A #DD0019 #DF0017 #E10017 #E20015 #E40014 #E60012 #E70011 #E90010 #EA000F #EC000D #ED000C #EF000B #F1000B #F2000A #F40008 #F50007 #F60006 #F70005 #F90005 #F90003 #FB0003 #FC0002 #FD0001 #FE0001 #FF0000 #FF0100 #FF0200 #FF0300 #FF0500 #FF0600 #FF0600 #FF0800 #FF0900 #FF0B00 #FF0C00 #FF0D00 #FF0F00 #FF1000 #FF1200 #FF1400 #FF1500 #FF1700 #FF1900 #FF1A00 #FF1C00 #FF1D00 #FF2000 #FF2200 #FF2300 #FF2500 #FF2700 #FF2900 #FF2B00 #FF2D00 #FF2F00 #FF3100 #FF3400 #FF3500 #FF3700 #FF3900 #FF3C00 #FF3E00 #FF4000 #FF4200 #FF4400 #FF4700 #FF4900 #FF4B00 #FF4E00 #FF5000 #FF5200 #FF5500 #FF5700 #FF5900 #FF5C00 #FF5E00 #FF6100 #FF6300 #FF6600 #FF6800 #FF6A00 #FF6C00 #FF6F00 #FF7200 #FF7400 #FF7700 #FF7900 #FF7C00 #FF7E00 #FF8000 #FF8300 #FF8500 #FF8700 #FF8A00 #FF8D00 #FF8F00 #FF9200 #FF9500 #FF9700 #FF9900 #FF9B00 #FF9E00 #FFA000 #FFA300 #FFA500 #FFA700 #FFA900 #FFAC00 #FFAE00 #FFB100 #FFB200 #FFB600 #FFB700 #FFBA00 #FFBC00 #FFBE00 #FFC100 #FFC300 #FFC400 #FFC700 #FFC900 #FFCB00 #FFCD00 #FFCF00 #FFD100 #FFD300 #FFD500 #FFD700 #FFD900 #FFDB00 #FFDD00 #FFDE00 #FFE000 #FFE100 #FFE400 #FFE500 #FFE700 #FFE900 #FFEA00 #FFEB00 #FFED00 #FFEF00 #FFF000 #FFF100 #FFF300 #FFF400 #FFF500 #FFF600 #FFF800 #FFF900 #FFFA00 #FFFB00".split(" ");
class PlainAnalyzer extends Analyzer{constructor(a,b,c,d){super(a,b,d);this.sampleRate=c.sampleRate;this.analyzerL=a.createAnalyser();this.analyzerL.fftSize=1024;this.analyzerR=a.createAnalyser();this.analyzerR.fftSize=1024;this.visibleFrequencies=c.visibleFrequencies;a=cLib.HEAP8.buffer;this.dataPtr=this.ptr=b=cLib._allocBuffer(19456+cLib._fftSizeOff(2048));this.data=new Uint8Array(a,b,1024);this.tmpPtr=b+=1024;this.tmp=new Float32Array(a,b,2048);this.windowPtr=b+=8192;this.window=new Float32Array(a,
b,1024);this.multiplierPtr=b+=4096;this.multiplier=new Float32Array(a,b,512);this.prevLPtr=b+=2048;this.prevL=new Float32Array(a,b,512);this.prevRPtr=b+=2048;this.prevR=new Float32Array(a,b,512);this.fft4gfPtr=b+2048;cLib._fftInitf(this.fft4gfPtr,2048);d=this.window;a=this.multiplier;const e=Math.PI;b=Math.exp;const g=Math.cos;c=1/Math.LN10;for(let f=0;1024>f;f++)d[f]=4*(.54-.46*g(2*e*f/1023));for(d=0;512>d;d++)a[d]=145*c*b(2.5*d/511)}analyze(a){a=this.multiplier;const b=this.tmp,c=this.ctx,d=this.sampleRate/
2048,e=this.visibleFrequencies,g=Analyzer.colors;var f;let h,k,l,m;this.analyzerL.getByteTimeDomainData(this.data);cLib._plainAnalyzer(this.fft4gfPtr,this.windowPtr,this.dataPtr,this.tmpPtr);let q=this.prevL;c.lineWidth=1;c.fillStyle="#000000";c.fillRect(0,0,512,512);for(k=h=0;511>k&&1024>h&&d>e[k+1]-e[k];){for(f=d*h;1024>h&&f+d<e[k];)h++,f=d*h;f=(4*q[k]+a[k]*lerp(f,b[h],f+d,b[h+1],e[k]))/2.5>>1;255<f?f=255:0>f&&(f=0);q[k]=f;c.beginPath();c.strokeStyle=g[f];c.moveTo(k-.5,256.5-f);c.lineTo(k-.5,256.5);
c.stroke();k++}for(h++;1024>h&&512>k;){m=l=0;do l+=b[h],m++,h++,f=d*h;while(f<e[k]&&1024>h);f=(4*q[k]+a[k]*l/m)/2.5>>1;255<f?f=255:0>f&&(f=0);q[k]=f;c.beginPath();c.strokeStyle=g[f];c.moveTo(k-.5,256.5-f);c.lineTo(k-.5,256.5);c.stroke();k++}this.analyzerR.getByteTimeDomainData(this.data);cLib._plainAnalyzer(this.fft4gfPtr,this.windowPtr,this.dataPtr,this.tmpPtr);q=this.prevR;for(k=h=0;511>k&&1024>h&&d>e[k+1]-e[k];){for(f=d*h;1024>h&&f+d<e[k];)h++,f=d*h;f=(4*q[k]+a[k]*lerp(f,b[h],f+d,b[h+1],e[k]))/
2.5>>1;255<f?f=255:0>f&&(f=0);q[k]=f;c.beginPath();c.strokeStyle=g[f];c.moveTo(k-.5,256.5);c.lineTo(k-.5,256.5+f);c.stroke();k++}for(h++;1024>h&&512>k;){m=l=0;do l+=b[h],m++,h++,f=d*h;while(f<e[k]&&1024>h);f=(4*q[k]+a[k]*l/m)/2.5>>1;255<f?f=255:0>f&&(f=0);q[k]=f;c.beginPath();c.strokeStyle=g[f];c.moveTo(k-.5,256.5);c.lineTo(k-.5,256.5+f);c.stroke();k++}}cleanUp(){this.ptr&&cLib._freeBuffer(this.ptr)}}
class SoundParticlesAnalyzer extends Analyzer{constructor(a,b,c,d){super(a,b,d,!0,Analyzer.controlWidth,320);this.BG_COLUMNS=31;this.BG_PARTICLES_BY_COLUMN=16;this.BG_COUNT=this.BG_COLUMNS*this.BG_PARTICLES_BY_COLUMN;this.lastTime=0;this.analyzerL=a.createAnalyser();this.analyzerL.fftSize=1024;this.analyzerL.maxDecibels=-12;this.analyzerL.minDecibels=-45;this.analyzerL.smoothingTimeConstant=0;this.analyzerR=a.createAnalyser();this.analyzerR.fftSize=1024;this.analyzerR.maxDecibels=-12;this.analyzerR.minDecibels=
-45;this.analyzerR.smoothingTimeConstant=0;a=(g,f)=>{this.COLORS[3*g]=f};b=(g,f)=>{this.COLORS[3*g+1]=f};c=(g,f)=>{this.COLORS[3*g+2]=f};d=cLib.HEAP8.buffer;var e=cLib._allocBuffer(2240+8*this.BG_COUNT+8*this.BG_COUNT+this.BG_COUNT);this.processedDataPtr=this.ptr=e;this.processedData=new Uint8Array(d,e,512);this.processedDataRPtr=e+=512;this.processedDataR=new Uint8Array(d,e,512);this.fftPtr=e+=512;this.fft=new Float32Array(d,e,256);this.COLORSPtr=e+=1024;this.COLORS=new Float32Array(d,e,48);this.bgPosPtr=
e+=192;this.bgPos=new Float32Array(d,e,2*this.BG_COUNT);this.bgSpeedYPtr=e+=8*this.BG_COUNT;this.bgSpeedY=new Float32Array(d,e,this.BG_COUNT);this.bgThetaPtr=e+=4*this.BG_COUNT;this.bgTheta=new Float32Array(d,e,this.BG_COUNT);this.bgColorPtr=e+=4*this.BG_COUNT;this.bgColor=new Uint8Array(d,e,this.BG_COUNT);a(0,.75);b(0,0);c(0,0);a(1,0);b(1,.75);c(1,0);a(2,0);b(2,0);c(2,.75);a(3,.75);b(3,0);c(3,.75);a(4,.75);b(4,.75);c(4,0);a(5,0);b(5,.75);c(5,.75);a(6,.75);b(6,.75);c(6,.75);a(7,.75);b(7,.325);c(7,
0);a(8,.75);b(8,0);c(8,.325);a(9,.325);b(9,.75);c(9,0);a(10,0);b(10,.75);c(10,.325);a(11,0);b(11,.325);c(11,.75);a(12,.325);b(12,0);c(12,.75);a(13,0);b(13,0);c(13,.75);a(14,.75);b(14,.325);c(14,0);a(15,0);b(15,.325);c(15,.75);for(let g=0,f=0;g<this.BG_COLUMNS;g++)for(a=0;a<this.BG_PARTICLES_BY_COLUMN;a++,f++)this.fillBgParticle(f,-1.2+.01953125*(SoundParticlesAnalyzer.rand()&127));a=Program.create(this.canvas,{alpha:!1,depth:!1,stencil:!1,antialias:!1,premultipliedAlpha:!0},SoundParticlesAnalyzer.vertexShaderSource,
SoundParticlesAnalyzer.fragmentShaderSource);if(!a)throw this.err("Apparently your browser does not support WebGL"),Error();this.program=a;this.program.use();this.program.texColor(0);this.program.aspect(.625,1);a=this.program.gl;d=new Float32Array([-1,-1,0,1,1,-1,0,1,-1,1,0,1,1,1,0,1]);e=new Float32Array([0,1,1,1,0,0,1,0]);b=a.createBuffer();c=a.createBuffer();!a.getError()&&b&&c||this.err(-1);a.bindBuffer(a.ARRAY_BUFFER,b);a.bufferData(a.ARRAY_BUFFER,d,a.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,
c);a.bufferData(a.ARRAY_BUFFER,e,a.STATIC_DRAW);a.clearColor(0,0,0,1);a.pixelStorei(a.UNPACK_ALIGNMENT,2);a.disable(a.DEPTH_TEST);a.disable(a.CULL_FACE);a.disable(a.DITHER);a.disable(a.SCISSOR_TEST);a.disable(a.STENCIL_TEST);a.enable(a.BLEND);a.blendFunc(a.ONE,a.ONE);a.blendEquation(a.FUNC_ADD);a.getError();d=a.createTexture();!a.getError()&&d||this.err(-2);a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,d);a.getError()&&this.err(-3);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);
a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);this.fillTexture();a.getError()&&this.err(-4);a.enableVertexAttribArray(0);a.bindBuffer(a.ARRAY_BUFFER,b);a.vertexAttribPointer(0,4,a.FLOAT,!1,0,0);a.enableVertexAttribArray(1);a.bindBuffer(a.ARRAY_BUFFER,c);a.vertexAttribPointer(1,2,a.FLOAT,!1,0,0)}static rand(){return 65536*Math.random()|0}err(a){this.destroy();
alert("Sorry! WebGL error :(\n"+a);throw a;}fillBgParticle(a,b){this.bgPos[a<<1]=.0078125*((SoundParticlesAnalyzer.rand()&7)-4);this.bgPos[(a<<1)+1]=b;this.bgTheta[a]=.03125*(SoundParticlesAnalyzer.rand()&63);this.bgSpeedY[a]=.125+.00390625*(SoundParticlesAnalyzer.rand()&15);this.bgColor[a]=SoundParticlesAnalyzer.rand()&15}fillTexture(){const a=this.program.gl,b=Math.sqrt,c=new Uint8Array(4096);for(let e=0;64>e;e++){let g=e-32;g*=g;for(let f=0;64>f;f++){var d=f-32;d=b(d*d+g)/30;1<d&&(d=1);let h=d;
d=1-d;d*=d;d+=.5*d;.55>d?d=0:1>d&&(d=smoothStep(.55,1,d));h=1-h;h=smoothStep(0,1,h);h*=h;h+=h;1<h&&(h=1);d+=.5*h;d=255*d|0;c[64*e+f]=255<=d?255:d}}a.texImage2D(a.TEXTURE_2D,0,a.ALPHA,64,64,0,a.ALPHA,a.UNSIGNED_BYTE,c)}analyze(a){let b=a-this.lastTime;33<b&&(b=33);this.lastTime=a;a=this.program.gl;var c=.00390625*b,d=1-c;const e=this.processedData,g=this.processedDataR,f=this.fft,h=this.BG_COLUMNS,k=this.BG_PARTICLES_BY_COLUMN,l=this.COLORS,m=this.program,q=this.bgPos,n=this.bgSpeedY,p=this.bgColor,
r=this.bgTheta,u=Math.max;let t,x=44,y=116;b*=.001;this.analyzerL.getByteFrequencyData(e);this.analyzerR.getByteFrequencyData(g);for(t=0;256>t;t++){let v=u(e[t],g[t]);8>v&&(v=0);const w=f[t];v<w&&(v=c*v+d*w);f[t]=v;e[t]=255<=v?255:v}a.clear(a.COLOR_BUFFER_BIT);t=2;for(let v=0,w=0;v<h;v++){if(6>t)c=.00390625*e[t],t++;else if(20>t)c=.005859375*u(e[t],e[t+1]),t+=2;else if(36>t)c=.005859375*u(e[t],e[t+1],e[t+2],e[t+3]),t+=4;else if(100>t){for(c=0;t<x;t++)c=u(c,e[t]);c*=.0078125;x+=8}else{for(c=0;t<y;t++)c=
u(c,e[t]);c*=.009765625;y+=16}m.amplitude(1<=c?1:c);m.baseX(-.9+.06206897*v);for(c=0;c<k;c++,w++)1.2<q[(w<<1)+1]?this.fillBgParticle(w,-1.2):q[(w<<1)+1]+=n[w]*b,d=3*p[w],m.color(l[d],l[d+1],l[d+2]),d=w<<1,m.pos(q[d],q[d+1]),m.theta(r[w]),a.drawArrays(a.TRIANGLE_STRIP,0,4)}}cleanUp(){this.ptr&&cLib._freeBuffer(this.ptr);this.program&&this.program.destroy()}}SoundParticlesAnalyzer.vertexShaderSource="precision mediump float;\nattribute vec4 inPosition;\nattribute vec2 inTexCoord;\nuniform float amplitude;\nuniform float baseX;\nuniform vec2 pos;\nuniform vec2 aspect;\nuniform vec3 color;\nuniform float theta;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\n\nvoid main() {\n\tfloat a = mix(0.0625, 0.34375, amplitude);\n\tfloat bottom = 1.0 - clamp(pos.y, -1.0, 1.0);\n\tbottom = bottom * bottom * bottom * 0.125;\n\ta = (0.75 * a) + (0.25 * bottom);\n\tgl_Position = vec4(baseX + pos.x + (5.0 * (pos.y + 1.0) * pos.x * sin((2.0 * pos.y) + theta)) + (inPosition.x * aspect.x * a), pos.y + (inPosition.y * aspect.y * a), 0.0, 1.0);\n\tvTexCoord = inTexCoord;\n\tvColor = color + bottom + (0.25 * amplitude);\n}";
SoundParticlesAnalyzer.fragmentShaderSource="precision lowp float;\nuniform sampler2D texColor;\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\n\nvoid main() {\n\tfloat a = texture2D(texColor, vTexCoord).a;\n\tgl_FragColor = vec4(vColor.rgb * a, 1.0);\n}";
class WaveletAnalyzer extends Analyzer{constructor(a,b,c,d){super(a,b,d);this.analyzerL=a.createAnalyser();this.analyzerL.fftSize=128;this.analyzerR=a.createAnalyser();this.analyzerR.fftSize=128;a=cLib.HEAP8.buffer;this.dataLPtr=this.ptr=b=cLib._allocBuffer(1536);this.dataL=new Uint8Array(a,b,128);this.dataRPtr=b+=128;this.dataR=new Uint8Array(a,b,128);this.tmpPtr=b+=128;this.tmp=new Float32Array(a,b,64);this.oL1Ptr=b+=256;this.oL1=new Float32Array(a,b,128);this.oR1Ptr=b+=512;this.oR1=new Float32Array(a,
b,128)}analyze(a){a=this.ctx;const b=Analyzer.colors,c=this.oL1,d=this.oR1;this.analyzerL.getByteTimeDomainData(this.dataL);this.analyzerR.getByteTimeDomainData(this.dataR);cLib._waveletAnalyzer(this.dataLPtr,this.dataRPtr,this.tmpPtr,this.oL1Ptr,this.oR1Ptr);let e,g,f=64,h=Analyzer.controlWidth/64,k,l=0,m=Analyzer.controlHeight-32;for(;;){e=f;for(k=0;512>k;)g=c[e],0>g&&(g=-g),g=127<=g?508:g<<2,a.fillStyle=b[g>>>1],a.fillRect(k,l,h,32),g=d[e],0>g&&(g=-g),g=127<=g?508:g<<2,a.fillStyle=b[g>>>1],a.fillRect(k,
m,h,32),e++,k+=h;h<<=1;l+=32;m-=32;if(!f)break;(f>>>=1)||(h=512)}}cleanUp(){this.ptr&&cLib._freeBuffer(this.ptr)}};
